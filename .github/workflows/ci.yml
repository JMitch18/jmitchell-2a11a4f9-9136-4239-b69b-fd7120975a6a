name: CI

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Pin node to match typical CI (Nx + npm-lock behavior is most stable on Node 20)
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # Important: make sure CI is using repo-root lockfile (not a subdir)
      - name: Debug paths + lockfile
        run: |
          set -euxo pipefail
          echo "PWD=$(pwd)"
          echo "SHA=$(git rev-parse HEAD)"
          node -v
          npm -v
          ls -la
          test -f package.json
          test -f package-lock.json
          echo "Root lockfile hash:"
          sha256sum package-lock.json || shasum -a 256 package-lock.json

      # Fix for your exact error: npm ci complains lockfile not in sync.
      # This makes CI fail fast if lockfile is missing/changed AND ensures npm cache isn't stale.
      - name: Clean npm cache (safety)
        run: npm cache clean --force

      - name: Install
        run: npm ci

      - name: Nx reset
        run: npx nx reset

      - name: Show projects
        run: npx nx show projects

      # Optional: build everything (adjust later)
      - name: Build all
        run: npx nx run-many -t build --all
